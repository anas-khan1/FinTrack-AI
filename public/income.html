<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income — FinTrack AI</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='32' y2='32'%3E%3Cstop stop-color='%236366f1'/%3E%3Cstop offset='1' stop-color='%238b5cf6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='8' fill='url(%23g)'/%3E%3Crect x='6' y='18' width='5' height='8' rx='1.5' fill='rgba(255,255,255,0.5)'/%3E%3Crect x='13.5' y='13' width='5' height='13' rx='1.5' fill='rgba(255,255,255,0.7)'/%3E%3Crect x='21' y='7' width='5' height='19' rx='1.5' fill='white'/%3E%3C/svg%3E">
</head>
<body>
    <div class="bg-effects"><div class="bg-orb bg-orb-1"></div><div class="bg-orb bg-orb-2"></div></div>
    <div class="app-layout">
        <div id="sidebarContainer"></div>
        <main class="main-content">
            <div class="page-header">
                <div class="page-header-inner">
                    <div><button class="mobile-menu-btn" id="mobileMenuBtn"></button><h1 class="page-title">Income</h1><p class="page-subtitle">Track your earnings and income sources</p></div>
                    <div class="page-header-actions">
                        <button class="btn btn-ghost btn-sm" id="exportIncBtn" title="Export CSV"></button>
                        <button class="btn btn-primary btn-sm" id="addIncomeBtn"></button>
                    </div>
                </div>
            </div>
            <div class="page-body">
                <div class="summary-bar">
                    <div class="summary-stat">Total: <strong id="incTotal">₹0</strong></div>
                    <div class="summary-stat">Entries: <strong id="incCount">0</strong></div>
                    <div class="summary-stat">Average: <strong id="incAvg">₹0</strong></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Income Entries</span></div>
                    <div class="card-body" style="padding:0">
                        <table class="data-table" id="incomeTable">
                            <thead><tr><th>Date</th><th>Source</th><th>Description</th><th style="text-align:right">Amount</th><th></th></tr></thead>
                            <tbody id="incomeTbody"></tbody>
                        </table>
                        <div class="empty-state" id="incomeEmpty" style="display:none">
                            <div class="empty-state-icon" id="emptyIncIcon"></div>
                            <div class="empty-state-text">No income entries yet</div>
                            <div class="empty-state-hint">Click "Add Income" to start tracking</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="incomeModal">
        <div class="modal">
            <h3>Add Income</h3>
            <form id="incomeForm">
                <div class="form-row">
                    <div class="form-group"><label>Amount (₹)</label><input type="number" class="form-input" id="incAmount" placeholder="0" min="1" required></div>
                    <div class="form-group"><label>Source</label>
                        <select class="form-select" id="incSource" required>
                            <option value="Salary">Salary</option><option value="Freelance">Freelance</option><option value="Investment">Investment</option>
                            <option value="Business">Business</option><option value="Gift">Gift</option><option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description</label><input type="text" class="form-input" id="incDescription" placeholder="Details..."></div>
                <div class="form-group"><label>Date</label><input type="date" class="form-input" id="incDate" required></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary btn-sm" id="cancelIncomeBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm">Save Income</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/icons.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/components.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!requireAuth()) return;
        document.getElementById('sidebarContainer').innerHTML = renderSidebar('income');
        initSidebar();

        document.getElementById('mobileMenuBtn').innerHTML = Icons.menu;
        document.getElementById('addIncomeBtn').innerHTML = `${Icons.plus} Add Income`;
        document.getElementById('exportIncBtn').innerHTML = `${Icons.download} Export`;
        if (document.getElementById('emptyIncIcon')) document.getElementById('emptyIncIcon').innerHTML = Icons.income;

        const modal = document.getElementById('incomeModal');
        document.getElementById('addIncomeBtn').addEventListener('click', () => { document.getElementById('incDate').value = new Date().toISOString().split('T')[0]; modal.classList.add('active'); });
        document.getElementById('cancelIncomeBtn').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });

        let allIncome = [];

        async function loadIncome() {
            try {
                const data = await API.get('/income');
                allIncome = data.income;
                const tbody = document.getElementById('incomeTbody');
                const empty = document.getElementById('incomeEmpty');
                const table = document.getElementById('incomeTable');

                const total = allIncome.reduce((s, i) => s + i.amount, 0);
                document.getElementById('incTotal').textContent = formatCurrency(total);
                document.getElementById('incCount').textContent = allIncome.length;
                document.getElementById('incAvg').textContent = allIncome.length > 0 ? formatCurrency(total / allIncome.length) : '\u20B90';

                if (allIncome.length === 0) { table.style.display = 'none'; empty.style.display = 'block'; }
                else {
                    table.style.display = 'table'; empty.style.display = 'none';
                    tbody.innerHTML = allIncome.map(i => `
                        <tr>
                            <td>${new Date(i.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}</td>
                            <td><span class="category-badge">${sourceDot(i.source)} ${i.source}</span></td>
                            <td style="color:var(--text-secondary)">${i.description || '\u2014'}</td>
                            <td style="text-align:right;font-weight:600;color:var(--success)">+${formatCurrency(i.amount)}</td>
                            <td><button class="action-btn delete" data-id="${i.id}" title="Delete">${Icons.trash}</button></td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.action-btn.delete').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            if (confirm('Delete this income entry?')) { await API.delete(`/income/${btn.dataset.id}`); showToast('Income deleted'); loadIncome(); }
                        });
                    });
                }
            } catch (err) { showToast('Failed to load income', 'error'); }
        }

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await API.post('/income', { amount: parseFloat(document.getElementById('incAmount').value), source: document.getElementById('incSource').value, description: document.getElementById('incDescription').value, date: document.getElementById('incDate').value });
                modal.classList.remove('active'); document.getElementById('incomeForm').reset(); showToast('Income added'); loadIncome();
            } catch (err) { showToast(err.message, 'error'); }
        });

        document.getElementById('exportIncBtn').addEventListener('click', () => {
            if (allIncome.length === 0) { showToast('No data to export', 'error'); return; }
            const rows = [['Date', 'Source', 'Description', 'Amount']];
            allIncome.forEach(i => rows.push([i.date, i.source, i.description || '', i.amount]));
            exportToCSV('fintrack_income.csv', rows);
            showToast('Exported income');
        });

        loadIncome();
    });
    </script>
</body>
</html>
